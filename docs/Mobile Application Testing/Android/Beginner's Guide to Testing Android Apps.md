Android is a mobile operating system developed by Google. It is based on a modified version of the Linux kernel. It runs on the ARM/ARM64 hardware platform but there are x86/64 Android builds.

Android applications are written in Java can be decompiled easily. Android apps are deployed using APKs, which govern how it's installed on a device. An APK is essentially a ZIP file with specific content. It consists of:

- `AndroidManifest.xml` - declares app attributes, config and metadata.
- `classes.dex` - compiled app code
- `resources.arsc` - compiled app resources
- `res/` - folder with non-compiled resources
- `assets/` - optional folder with app assets
- `lib/` - optional folder containing compiled code e.g. 3rd party libraries
- `META-INF/` - contains `MANIFEST.MF`, which contains metadata about the package

## Testing on a Physical Device
### Accessing Android CLI
The Android OS can be accessed using CLI.

1. Install Android Studio on your laptop
	1. This will install Android Platform Tools which includes `adb` (Android Debug Bridge) and Fastboot
2. Connect your Android device to the laptop via USB
3. Enable Debugging interface on the phone. This allows us to interact with the device using `adb`
	1. Go to About Device and click 7 times on the Build Number to Enable Developer options
	2. Go to Developer options and click on Enable "USB Debugging"
4. Start an `adb shell` on your testing laptop. The `adb` executable should be under the path `C:\Users\{username}\AppData\Local\Android\Sdk\platform-tools>` if installed with Android Studio.

```
adb shell
```

### Pairing an Android Device to Laptop via Wifi
If you don't have a USB cable, you can connect pair the android device via wifi

*Requirements: Developer options need to be enabled*

1. Connect the Android phone to the same Wifi as the laptop
2. Search pair in settings
3. Select pair device with pairing code
4. Type the following on your laptop to connect the device the laptop 

```
adb pair ip:port
```

### Rooting a physical device
Rooting a device is not necessary but brings about some **benefits**, including:

- Full access to the operating system
- Makes it easy to install tools
- Allows us to install our Burp certificate as a system-level trusted certificate (so we don't get errors in our Burp dashboard!)

**Drawbacks to rooting a device**
- Some phones have a warranty bit that burns each time the boot loader is unlocked
- Locks you out of functionality like Google Pay
- Unlocking boot loader deletes all data

Tutorials on rooting device: [How to root your Android smartphone: Google, OnePlus, Samsung, Xiaomi, and more (xda-developers.com)](https://www.xda-developers.com/root/)

Checkout Checkra1n or Unc0ver to jailbreak. Some useful tools to install after jailbreak:
- Magisk
- Root checker

### Testing
##### Proxying traffic to Burp
1. Install Burp Certificate on the device (see [[pentesting/docs/Mobile Application Testing/Android/Installing Burp Certificates|Installing Burp Certificates]])
2. Start a mobile hotspot on the test laptop
3. Open a new Burp project
4. Set the proxy listener to the local network IP (mobile hotspot router IP)
6. Join hotspot wifi network
7. Go to wifi settings
8. Edit settings for current wifi network
9. Select "Advanced Settings" 
10. Find "Proxy"
11. Set proxy to `192.168.137.1:8080` or equivalent IP and port that Burp is listening to
12. Visit browser and search google to see requests
## Testing on an Emulator
### Setting up
1. Install Android Studio on your laptop
2. Download an Emulator on Android Studio
	1. Go to Settings  > Appearance & Behaviour > System Settings > Android SDK
	2. Select the latest version of Android Emulator in SDK Tools tab
	3. Go to Tools > Device Manager. Select Create Device
3. Drag the `.apk` file of your application to the emulator to install the app on the device

### Rooting an emulator
There's no need to root an emulator. You can simply start `adb` as root.
```
adb root
adb shell
emu64xa:/
```
If you need a writable file system e.g. to install the a system-level trusted Burp certificate on the emulator, start the emulator from CLI using the `-writable-system` option
```
.\emulator.exe -writable-system -avd Pixel_3a_API_34_extension_level_7_x86_64
```

I found that this method works sometimes but at times the Burp cert will only install as a user-level trusted certificate. This might be because of some subtleties with Google APIs version 28 and later. To get around this, you'll need create an emulator which supports Google APIs before version 28 and install Magisk on the emulator. See this guide for more information - [[pentesting/docs/Mobile Application Testing/Android/Installing Burp Certificates|Installing Burp Certificates]].
### Testing
##### Proxying traffic to Burp
1. Install Burp Certificate on the device (see [[pentesting/docs/Mobile Application Testing/Android/Installing Burp Certificates|Installing Burp Certificates]]])
2. Create a new Burp project
4. Open an emulator in Android Studio
5. With emulator open, click on More ![](Pasted%20image%2020230626134741.png)
6. Click on Settings and Proxy
7. Select Manual proxy configuration
8. Enter the IP and Port that Burp is listening on

![](pentesting/docs/Mobile%20Application%20Testing/Android/attachments/Pasted%20image%2020230626134937.png)

## Troubleshooting
### No traffic showing in Burp Proxy History
This is likely due to Windows Firewall blocking traffic from the Android Device. Turn off the Private and Public Firewall and send traffic again.
![](pentesting/docs/Mobile%20Application%20Testing/Android/attachments/Pasted%20image%2020230626141111.png)
### Errors showing on Burp Dashboard
This could be because of SSL Pinning. Implement the following fixes to bypass SSL Pinning.

*See more to bypass SSL Pinning*
https://justinpineda.com/2020/11/27/bypassing-ssl-pinning-and-traffic-redirection-to-burp-suite-using-mobsf-and-genymotion/
### The emulator device is slow AF
Increase the RAM on the device. Right click on the emulator in AVD manager and click on **Show on disk**. Edit the hw.ramSize in `config.ini`. The default size is 1536 MB. Increasing it to 4096 MB will work a charm.